'use client';

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Accordion, AccordionItem, AccordionTrigger, AccordionContent } from '@/components/ui/accordion';
import { PresentationItem, BadgeType, Badge as BadgeTypeDefinition, MediaType } from '@/lib/selections/types';
import { PREDEFINED_BADGES, createBadge } from '@/lib/badges/badge-config';
import { BadgeDisplay } from '@/components/ui/badge-display';
import { ArrowUp, ArrowDown, Plus, ChevronRight } from 'lucide-react';
import { useState, useEffect } from 'react';
import { CollectionImageGallery } from './collection-image-gallery';

interface PropertiesInspectorProps {
  selectedItem: PresentationItem | null;
  onUpdate: (id: string, properties: Partial<PresentationItem['properties']>) => void;
  onBulkUpdate?: (properties: Partial<PresentationItem['properties']>) => void;
  selectionCount?: number;
  presentationItems?: PresentationItem[];
  onMoveUp?: (id: string) => void;
  onMoveDown?: (id: string) => void;
  presentationName?: string;
  vendorName?: string;
}

export function PropertiesInspector({
  selectedItem,
  onUpdate,
  onBulkUpdate,
  selectionCount = 0,
  presentationItems = [],
  onMoveUp,
  onMoveDown,
  presentationName,
  vendorName,
}: PropertiesInspectorProps) {
  const isBulkMode = selectionCount > 1;

  // Collection badge management state
  const [selectedBadgeType, setSelectedBadgeType] = useState<BadgeType>('dallas-favorite');
  const [customBadgeLabel, setCustomBadgeLabel] = useState('');
  const [customBadgeColor, setCustomBadgeColor] = useState('bg-gray-500');

  // Product badges state
  const [products, setProducts] = useState<any[]>([]);
  const [loadingProducts, setLoadingProducts] = useState(false);
  const [expandedProduct, setExpandedProduct] = useState<string | null>(null);
  const [productBadgeType, setProductBadgeType] = useState<BadgeType>('dallas-favorite');
  const [productBadgeLabel, setProductBadgeLabel] = useState('');
  const [productBadgeColor, setProductBadgeColor] = useState('bg-gray-500');

  // Migrate old heroVideoUrl to new media structure
  useEffect(() => {
    if (selectedItem?.type === 'collection' && selectedItem.collectionData?.heroVideoUrl && !selectedItem.properties.media) {
      const heroVideoUrl = selectedItem.collectionData.heroVideoUrl;

      // Detect if it's YouTube or MP4
      const isYouTube = heroVideoUrl.includes('youtube.com') || heroVideoUrl.includes('youtu.be') || heroVideoUrl.startsWith('youtube:');

      // Auto-migrate to new media structure
      onUpdate(selectedItem.id, {
        media: {
          mediaType: isYouTube ? 'youtube' : 'mp4',
          ...(isYouTube ? { youtubeUrl: heroVideoUrl } : { mp4Url: heroVideoUrl }),
        },
      });
    }
  }, [selectedItem?.id, selectedItem?.collectionData?.heroVideoUrl, selectedItem?.properties.media, onUpdate]);

  // Fetch products when a collection is selected
  useEffect(() => {
    if (selectedItem?.type === 'collection' && selectedItem.collectionData?.collectionName) {
      const collectionName = selectedItem.collectionData.collectionName;
      const fetchProducts = async () => {
        setLoadingProducts(true);
        try {
          // Fetch products from the catalog API
          const response = await fetch(`/api/catalog/search?collection=${encodeURIComponent(collectionName)}`);
          if (response.ok) {
            const data = await response.json();
            setProducts(data.products || []);
          }
        } catch (error) {
          console.error('Failed to fetch products:', error);
        } finally {
          setLoadingProducts(false);
        }
      };
      fetchProducts();
    } else {
      setProducts([]);
    }
  }, [selectedItem?.id]);

  // Collection badge management handlers
  const handleAddBadge = () => {
    if (!selectedItem) return;

    const isCustom = selectedBadgeType === 'custom';
    const label = isCustom ? customBadgeLabel : undefined;
    const color = isCustom ? customBadgeColor : undefined;

    if (isCustom && !customBadgeLabel.trim()) {
      return; // Don't add empty custom badges
    }

    const newBadge = createBadge(selectedBadgeType, label, color);
    const currentBadges = selectedItem.properties.badges || [];

    onUpdate(selectedItem.id, {
      badges: [...currentBadges, newBadge],
    });

    // Reset custom badge inputs
    if (isCustom) {
      setCustomBadgeLabel('');
      setCustomBadgeColor('bg-gray-500');
    }
  };

  const handleRemoveBadge = (badgeId: string) => {
    if (!selectedItem) return;

    const currentBadges = selectedItem.properties.badges || [];
    onUpdate(selectedItem.id, {
      badges: currentBadges.filter((b) => b.id !== badgeId),
    });
  };

  // Product badge management handlers
  const handleAddProductBadge = (sku: string) => {
    if (!selectedItem) return;

    const isCustom = productBadgeType === 'custom';
    const label = isCustom ? productBadgeLabel : undefined;
    const color = isCustom ? productBadgeColor : undefined;

    if (isCustom && !productBadgeLabel.trim()) {
      return; // Don't add empty custom badges
    }

    const newBadge = createBadge(productBadgeType, label, color);
    const currentSkuBadges = selectedItem.properties.skuBadges || {};
    const skuBadges = currentSkuBadges[sku] || [];

    onUpdate(selectedItem.id, {
      skuBadges: {
        ...currentSkuBadges,
        [sku]: [...skuBadges, newBadge],
      },
    });

    // Reset custom badge inputs
    if (isCustom) {
      setProductBadgeLabel('');
      setProductBadgeColor('bg-gray-500');
    }
  };

  const handleRemoveProductBadge = (sku: string, badgeId: string) => {
    if (!selectedItem) return;

    const currentSkuBadges = selectedItem.properties.skuBadges || {};
    const skuBadges = currentSkuBadges[sku] || [];

    onUpdate(selectedItem.id, {
      skuBadges: {
        ...currentSkuBadges,
        [sku]: skuBadges.filter((b) => b.id !== badgeId),
      },
    });
  };

  const getProductBadgeCount = (sku: string): number => {
    if (!selectedItem) return 0;
    const skuBadges = selectedItem.properties.skuBadges || {};
    return (skuBadges[sku] || []).length;
  };

  // When no collection is selected, show presentation-level details
  if (!selectedItem && selectionCount === 0) {
    return (
      <Card className="h-full overflow-auto">
        <CardHeader className="pb-4">
          <CardTitle className="text-sm">Presentation Overview</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Presentation Name */}
          <div>
            <Label className="text-xs font-medium text-muted-foreground">Presentation Name</Label>
            <p className="text-sm mt-1.5 font-medium">{presentationName || 'Untitled Presentation'}</p>
          </div>

          {/* Vendor */}
          {vendorName && (
            <div>
              <Label className="text-xs font-medium text-muted-foreground">Vendor</Label>
              <p className="text-sm mt-1.5">{vendorName}</p>
            </div>
          )}

          {/* Collection Count */}
          <div>
            <Label className="text-xs font-medium text-muted-foreground">Total Collections</Label>
            <p className="text-sm mt-1.5">{presentationItems.length}</p>
          </div>

          {/* Collection List */}
          {presentationItems.length > 0 && (
            <div>
              <Label className="text-xs font-medium text-muted-foreground mb-2 block">Collections</Label>
              <div className="space-y-1.5">
                {presentationItems.map((item, index) => (
                  <div key={item.id} className="flex items-center gap-2 text-xs p-2 rounded bg-muted/30">
                    <span className="text-muted-foreground font-mono">{index + 1}.</span>
                    <span className="flex-1 truncate">{item.collectionData?.collectionName}</span>
                    <Badge variant="secondary" className="text-xs shrink-0">
                      {item.collectionData?.productCount || 0} items
                    </Badge>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Empty State */}
          {presentationItems.length === 0 && (
            <div className="text-center py-8">
              <p className="text-sm text-muted-foreground">
                No collections added yet
              </p>
              <p className="text-xs text-muted-foreground mt-1">
                Drag collections from the source library to get started
              </p>
            </div>
          )}
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="h-full overflow-auto">
      <CardHeader className="pb-3">
        <CardTitle className="text-sm flex items-center justify-between">
          <span>Properties</span>
          {isBulkMode && (
            <Badge variant="muted" className="text-xs">
              {selectionCount} selected
            </Badge>
          )}
        </CardTitle>
        {selectedItem && !isBulkMode && selectedItem.type === 'collection' && (
          <CardDescription className="text-xs">
            {selectedItem.collectionData?.collectionName}
          </CardDescription>
        )}
      </CardHeader>

      <CardContent className="p-0">
        {/* Only show collection properties for collection items */}
        {selectedItem?.type === 'collection' && !isBulkMode && (
          <Accordion type="multiple" defaultValue={[]} className="w-full">
            {/* General Section */}
            <AccordionItem value="general">
              <AccordionTrigger className="px-6 text-sm font-medium">
                General
              </AccordionTrigger>
              <AccordionContent className="px-6">
                <div className="space-y-4">
                  {/* Custom Title */}
                  <div className="space-y-2">
                    <Label htmlFor="custom-title" className="text-sm font-medium">
                      Custom Title
                    </Label>
                    <Input
                      id="custom-title"
                      placeholder="Override collection name..."
                      value={selectedItem.properties.customTitle ?? ''}
                      onChange={(e) => onUpdate(selectedItem.id, { customTitle: e.target.value })}
                      className="text-sm"
                    />
                    <p className="text-xs text-muted-foreground">
                      Leave empty to use the default collection name
                    </p>
                  </div>

                  {/* Narrative Description */}
                  <div className="space-y-2">
                    <Label htmlFor="narrative-description" className="text-sm font-medium">
                      Narrative Description
                    </Label>
                    <Textarea
                      id="narrative-description"
                      placeholder="Add a compelling narrative for this collection..."
                      value={selectedItem.properties.narrativeDescription ?? ''}
                      onChange={(e) => onUpdate(selectedItem.id, { narrativeDescription: e.target.value })}
                      rows={4}
                      className="text-sm"
                    />
                    <p className="text-xs text-muted-foreground">
                      This description will appear above the collection
                    </p>
                  </div>

                  {/* Start Expanded Toggle */}
                  <div className="flex items-center justify-between">
                    <div className="space-y-0.5">
                      <Label htmlFor="start-expanded" className="text-sm font-medium">
                        Start Expanded
                      </Label>
                      <p className="text-xs text-muted-foreground">
                        Show products immediately
                      </p>
                    </div>
                    <Switch
                      id="start-expanded"
                      checked={selectedItem?.properties.startExpanded ?? false}
                      onCheckedChange={(checked) => onUpdate(selectedItem.id, { startExpanded: checked })}
                    />
                  </div>

                  {/* Show Product Count Toggle */}
                  <div className="flex items-center justify-between">
                    <div className="space-y-0.5">
                      <Label htmlFor="show-count" className="text-sm font-medium">
                        Show Product Count
                      </Label>
                      <p className="text-xs text-muted-foreground">
                        Display number of items
                      </p>
                    </div>
                    <Switch
                      id="show-count"
                      checked={selectedItem?.properties.showProductCount ?? true}
                      onCheckedChange={(checked) => onUpdate(selectedItem.id, { showProductCount: checked })}
                    />
                  </div>
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Collection Badges Section */}
            <AccordionItem value="collection-badges">
              <AccordionTrigger className="px-6 text-sm font-medium">
                Collection Badges
              </AccordionTrigger>
              <AccordionContent className="px-6">
                <div className="space-y-3">
                  <p className="text-xs text-muted-foreground">
                    Add badges to highlight this collection
                  </p>

                  {/* Badge Selection */}
                  <div className="space-y-2">
                    <Select
                      value={selectedBadgeType}
                      onValueChange={(value) => setSelectedBadgeType(value as BadgeType)}
                    >
                      <SelectTrigger className="text-sm">
                        <SelectValue placeholder="Select badge type..." />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="dallas-favorite">Dallas Market Favorite</SelectItem>
                        <SelectItem value="top-scanned">Top Scanned</SelectItem>
                        <SelectItem value="designers-pick">Designer's Pick</SelectItem>
                        <SelectItem value="show-highlight">Show Highlight</SelectItem>
                        <SelectItem value="best-selling-size">Best Selling Size</SelectItem>
                        <SelectItem value="custom">Custom Badge</SelectItem>
                      </SelectContent>
                    </Select>

                    {/* Custom Badge Inputs */}
                    {selectedBadgeType === 'custom' && (
                      <div className="space-y-2 pt-2">
                        <Input
                          placeholder="Badge text..."
                          value={customBadgeLabel}
                          onChange={(e) => setCustomBadgeLabel(e.target.value)}
                          className="text-sm"
                        />
                        <div className="space-y-1.5">
                          <Label className="text-xs">Badge Color</Label>
                          <Select value={customBadgeColor} onValueChange={setCustomBadgeColor}>
                            <SelectTrigger className="text-sm">
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="bg-blue-500">Blue</SelectItem>
                              <SelectItem value="bg-purple-500">Purple</SelectItem>
                              <SelectItem value="bg-pink-500">Pink</SelectItem>
                              <SelectItem value="bg-amber-500">Amber</SelectItem>
                              <SelectItem value="bg-green-500">Green</SelectItem>
                              <SelectItem value="bg-red-500">Red</SelectItem>
                              <SelectItem value="bg-indigo-500">Indigo</SelectItem>
                              <SelectItem value="bg-teal-500">Teal</SelectItem>
                              <SelectItem value="bg-gray-500">Gray</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </div>
                    )}

                    <Button
                      onClick={handleAddBadge}
                      size="sm"
                      className="w-full"
                      disabled={selectedBadgeType === 'custom' && !customBadgeLabel.trim()}
                    >
                      <Plus className="h-4 w-4 mr-1" />
                      Add Badge
                    </Button>
                  </div>

                  {/* Current Badges */}
                  {selectedItem.properties.badges && selectedItem.properties.badges.length > 0 && (
                    <div className="space-y-2">
                      <Label className="text-xs text-muted-foreground">Current Badges</Label>
                      <div className="flex flex-wrap gap-1.5">
                        {selectedItem.properties.badges.map((badge) => (
                          <BadgeDisplay
                            key={badge.id}
                            badge={badge}
                            onRemove={() => handleRemoveBadge(badge.id)}
                            size="sm"
                          />
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Product Badges Section */}
            <AccordionItem value="product-badges">
              <AccordionTrigger className="px-6 text-sm font-medium">
                Product Badges {products.length > 0 && `(${products.length})`}
              </AccordionTrigger>
              <AccordionContent className="px-6">
                <div className="space-y-3">
                  <p className="text-xs text-muted-foreground">
                    Add badges to individual products in this collection
                  </p>

                  {loadingProducts && (
                    <div className="text-xs text-muted-foreground py-4 text-center">
                      Loading products...
                    </div>
                  )}

                  {!loadingProducts && products.length === 0 && (
                    <div className="text-xs text-muted-foreground py-4 text-center">
                      No products found in this collection
                    </div>
                  )}

                  {!loadingProducts && products.length > 0 && (
                    <div className="space-y-2">
                      {products.map((product) => {
                        const badgeCount = getProductBadgeCount(product.sku);
                        const isExpanded = expandedProduct === product.sku;
                        const productBadges = selectedItem.properties.skuBadges?.[product.sku] || [];

                        return (
                          <div key={product.sku} className="border rounded-lg">
                            {/* Product Row */}
                            <button
                              onClick={() => setExpandedProduct(isExpanded ? null : product.sku)}
                              className="w-full flex items-center gap-3 p-3 hover:bg-muted/50 transition-colors"
                            >
                              {/* Chevron */}
                              <ChevronRight
                                className={`h-4 w-4 shrink-0 transition-transform ${
                                  isExpanded ? 'rotate-90' : ''
                                }`}
                              />

                              {/* Thumbnail */}
                              {product.images?.[0] && (
                                <img
                                  src={product.images[0]}
                                  alt={product.name}
                                  className="w-10 h-10 object-cover rounded shrink-0"
                                />
                              )}
                              {!product.images?.[0] && (
                                <div className="w-10 h-10 bg-muted rounded shrink-0" />
                              )}

                              {/* Product Info */}
                              <div className="flex-1 text-left min-w-0">
                                <div className="text-sm font-medium truncate">{product.name}</div>
                                <div className="text-xs text-muted-foreground">{product.sku}</div>
                              </div>

                              {/* Badge Count */}
                              {badgeCount > 0 && (
                                <Badge variant="secondary" className="text-xs shrink-0">
                                  {badgeCount} {badgeCount === 1 ? 'badge' : 'badges'}
                                </Badge>
                              )}
                            </button>

                            {/* Expanded Badge Management */}
                            {isExpanded && (
                              <div className="px-3 pb-3 space-y-3 border-t bg-muted/20">
                                <div className="pt-3 space-y-2">
                                  <Select
                                    value={productBadgeType}
                                    onValueChange={(value) => setProductBadgeType(value as BadgeType)}
                                  >
                                    <SelectTrigger className="text-sm">
                                      <SelectValue placeholder="Select badge type..." />
                                    </SelectTrigger>
                                    <SelectContent>
                                      <SelectItem value="dallas-favorite">Dallas Market Favorite</SelectItem>
                                      <SelectItem value="top-scanned">Top Scanned</SelectItem>
                                      <SelectItem value="designers-pick">Designer's Pick</SelectItem>
                                      <SelectItem value="show-highlight">Show Highlight</SelectItem>
                                      <SelectItem value="best-selling-size">Best Selling Size</SelectItem>
                                      <SelectItem value="custom">Custom Badge</SelectItem>
                                    </SelectContent>
                                  </Select>

                                  {/* Custom Badge Inputs */}
                                  {productBadgeType === 'custom' && (
                                    <div className="space-y-2 pt-2">
                                      <Input
                                        placeholder="Badge text..."
                                        value={productBadgeLabel}
                                        onChange={(e) => setProductBadgeLabel(e.target.value)}
                                        className="text-sm"
                                      />
                                      <div className="space-y-1.5">
                                        <Label className="text-xs">Badge Color</Label>
                                        <Select value={productBadgeColor} onValueChange={setProductBadgeColor}>
                                          <SelectTrigger className="text-sm">
                                            <SelectValue />
                                          </SelectTrigger>
                                          <SelectContent>
                                            <SelectItem value="bg-blue-500">Blue</SelectItem>
                                            <SelectItem value="bg-purple-500">Purple</SelectItem>
                                            <SelectItem value="bg-pink-500">Pink</SelectItem>
                                            <SelectItem value="bg-amber-500">Amber</SelectItem>
                                            <SelectItem value="bg-green-500">Green</SelectItem>
                                            <SelectItem value="bg-red-500">Red</SelectItem>
                                            <SelectItem value="bg-indigo-500">Indigo</SelectItem>
                                            <SelectItem value="bg-teal-500">Teal</SelectItem>
                                            <SelectItem value="bg-gray-500">Gray</SelectItem>
                                          </SelectContent>
                                        </Select>
                                      </div>
                                    </div>
                                  )}

                                  <Button
                                    onClick={() => handleAddProductBadge(product.sku)}
                                    size="sm"
                                    className="w-full"
                                    disabled={productBadgeType === 'custom' && !productBadgeLabel.trim()}
                                  >
                                    <Plus className="h-4 w-4 mr-1" />
                                    Add Badge
                                  </Button>
                                </div>

                                {/* Current Product Badges */}
                                {productBadges.length > 0 && (
                                  <div className="space-y-2">
                                    <Label className="text-xs text-muted-foreground">Current Badges</Label>
                                    <div className="flex flex-wrap gap-1.5">
                                      {productBadges.map((badge) => (
                                        <BadgeDisplay
                                          key={badge.id}
                                          badge={badge}
                                          onRemove={() => handleRemoveProductBadge(product.sku, badge.id)}
                                          size="sm"
                                        />
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Media Section */}
            {!isBulkMode && selectedItem?.type === 'collection' && (
              <AccordionItem value="media">
                <AccordionTrigger>
                  <div className="flex items-center justify-between w-full pr-2">
                    <span>Media</span>
                    {selectedItem.properties.media?.mediaType && selectedItem.properties.media.mediaType !== 'none' && (
                      <span className="text-xs text-muted-foreground">
                        {selectedItem.properties.media.mediaType === 'youtube' && 'YouTube Video'}
                        {selectedItem.properties.media.mediaType === 'mp4' && 'MP4 Video'}
                        {selectedItem.properties.media.mediaType === 'photos' && `${selectedItem.properties.media.photos?.length || 0} Photos`}
                        {selectedItem.properties.media.mediaType === 'immersive-slideshow' && `Immersive Slideshow â€¢ ${selectedItem.properties.media.photos?.length || 0} Photos`}
                      </span>
                    )}
                  </div>
                </AccordionTrigger>
                <AccordionContent className="px-6">
                  <div className="space-y-4">
                    {/* Media type selector */}
                    <div className="space-y-2">
                      <Label>Media Type</Label>
                      <Select
                        value={selectedItem.properties.media?.mediaType || 'none'}
                        onValueChange={(value) => {
                          onUpdate(selectedItem.id, {
                            media: {
                              mediaType: value as any,
                              // Clear other fields when switching types
                              ...(value === 'youtube' && { youtubeUrl: '', photos: undefined, mp4Url: undefined, immersive: undefined }),
                              ...(value === 'mp4' && { mp4Url: '', photos: undefined, youtubeUrl: undefined, immersive: undefined }),
                              ...(value === 'photos' && { photos: [], slideDuration: 5, photoLayoutMode: 'auto' as const, youtubeUrl: undefined, mp4Url: undefined, immersive: undefined }),
                              ...(value === 'immersive-slideshow' && {
                                photos: [],
                                immersive: {
                                  slideDurationSec: 8,
                                  fadeDurationSec: 0.8,
                                  kbIntensity: 'subtle' as const,
                                  motionSeed: 'auto' as const,
                                  order: 'as-uploaded' as const,
                                  reduceMotionOnMobile: true,
                                  showProgressDots: true,
                                  globalFocalPoint: 'center' as const,
                                },
                                youtubeUrl: undefined,
                                mp4Url: undefined,
                                photoLayoutMode: undefined,
                                slideDuration: undefined,
                              }),
                              ...(value === 'none' && { youtubeUrl: undefined, mp4Url: undefined, photos: undefined, immersive: undefined }),
                            },
                          });
                        }}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="none">None</SelectItem>
                          <SelectItem value="youtube">YouTube Video</SelectItem>
                          <SelectItem value="mp4">MP4 Video</SelectItem>
                          <SelectItem value="photos">Photo Slideshow</SelectItem>
                          <SelectItem value="immersive-slideshow">Immersive Slideshow</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    {/* YouTube Fields */}
                    {selectedItem.properties.media?.mediaType === 'youtube' && (
                      <div className="space-y-3">
                        <div className="space-y-2">
                          <Label>YouTube URL</Label>
                          <Input
                            value={selectedItem.properties.media.youtubeUrl || ''}
                            onChange={(e) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  youtubeUrl: e.target.value,
                                },
                              });
                            }}
                            placeholder="https://www.youtube.com/watch?v=..."
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <div className="space-y-2">
                            <Label className="text-xs">Start Time (seconds)</Label>
                            <Input
                              type="number"
                              value={selectedItem.properties.media.youtubeStartTime || ''}
                              onChange={(e) => {
                                onUpdate(selectedItem.id, {
                                  media: {
                                    ...selectedItem.properties.media!,
                                    youtubeStartTime: parseInt(e.target.value) || undefined,
                                  },
                                });
                              }}
                              placeholder="0"
                            />
                          </div>
                          <div className="space-y-2">
                            <Label className="text-xs">End Time (seconds)</Label>
                            <Input
                              type="number"
                              value={selectedItem.properties.media.youtubeEndTime || ''}
                              onChange={(e) => {
                                onUpdate(selectedItem.id, {
                                  media: {
                                    ...selectedItem.properties.media!,
                                    youtubeEndTime: parseInt(e.target.value) || undefined,
                                  },
                                });
                              }}
                              placeholder="30"
                            />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* MP4 Fields */}
                    {selectedItem.properties.media?.mediaType === 'mp4' && (
                      <div className="space-y-3">
                        <div className="space-y-2">
                          <Label>MP4 Video URL</Label>
                          <Input
                            value={selectedItem.properties.media.mp4Url || ''}
                            onChange={(e) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  mp4Url: e.target.value,
                                },
                              });
                            }}
                            placeholder="https://cdn.example.com/video.mp4"
                          />
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                          <div className="space-y-2">
                            <Label className="text-xs">Start Time (seconds)</Label>
                            <Input
                              type="number"
                              value={selectedItem.properties.media.mp4StartTime || ''}
                              onChange={(e) => {
                                onUpdate(selectedItem.id, {
                                  media: {
                                    ...selectedItem.properties.media!,
                                    mp4StartTime: parseInt(e.target.value) || undefined,
                                  },
                                });
                              }}
                              placeholder="0"
                            />
                          </div>
                          <div className="space-y-2">
                            <Label className="text-xs">End Time (seconds)</Label>
                            <Input
                              type="number"
                              value={selectedItem.properties.media.mp4EndTime || ''}
                              onChange={(e) => {
                                onUpdate(selectedItem.id, {
                                  media: {
                                    ...selectedItem.properties.media!,
                                    mp4EndTime: parseInt(e.target.value) || undefined,
                                  },
                                });
                              }}
                              placeholder="30"
                            />
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Photo Slideshow Fields */}
                    {selectedItem.properties.media?.mediaType === 'photos' && (
                      <div className="space-y-3">
                        <div className="space-y-2">
                          <Label>Slide Duration (seconds)</Label>
                          <Input
                            type="number"
                            value={selectedItem.properties.media.slideDuration || 5}
                            onChange={(e) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  slideDuration: parseInt(e.target.value) || 5,
                                },
                              });
                            }}
                            min="1"
                            max="30"
                          />
                        </div>
                        <div className="space-y-2">
                          <Label>Photo Layout Mode</Label>
                          <Select
                            value={selectedItem.properties.media.photoLayoutMode || 'auto'}
                            onValueChange={(value: 'auto' | 'single-fit' | 'single-fill' | 'pair-portraits' | 'manual') => {
                              console.log('[PropertiesInspector] Changing photoLayoutMode to:', value);
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  photoLayoutMode: value,
                                },
                              });
                            }}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="auto">Auto (Recommended)</SelectItem>
                              <SelectItem value="single-fit">Single - Fit</SelectItem>
                              <SelectItem value="single-fill">Single - Fill (Smart Crop)</SelectItem>
                              <SelectItem value="pair-portraits">Pair Portraits</SelectItem>
                              <SelectItem value="manual">Manual (Ken Burns Editor)</SelectItem>
                            </SelectContent>
                          </Select>
                          <p className="text-xs text-muted-foreground">
                            Auto mode smartly handles portrait and landscape photos for best presentation.
                          </p>
                        </div>

                        {/* Detect Dimensions Button */}
                        {selectedItem.properties.media?.photos && selectedItem.properties.media.photos.length > 0 && (
                          <div className="space-y-2">
                            <Button
                              type="button"
                              variant="outline"
                              size="sm"
                              className="w-full"
                              onClick={async () => {
                                const photos = selectedItem.properties.media!.photos!;
                                const photosNeedingDetection = photos.filter(p => !p.aspect || !p.aspectClass);

                                if (photosNeedingDetection.length === 0) {
                                  alert('All photos already have dimensions detected');
                                  return;
                                }

                                console.log('[PropertiesInspector] Detecting dimensions for', photosNeedingDetection.length, 'photos');

                                // Detect dimensions for all photos
                                const updatedPhotos = await Promise.all(
                                  photos.map((photo) => {
                                    // Skip if already has dimensions
                                    if (photo.aspect && photo.aspectClass) {
                                      return Promise.resolve(photo);
                                    }

                                    // Load image and detect
                                    return new Promise<typeof photo>((resolve) => {
                                      const img = new Image();
                                      img.crossOrigin = 'anonymous';
                                      img.onload = () => {
                                        const aspect = img.width / img.height;
                                        let aspectClass: 'landscape' | 'portrait' | 'square' = 'square';
                                        if (aspect >= 1.2) aspectClass = 'landscape';
                                        else if (aspect <= 0.85) aspectClass = 'portrait';

                                        resolve({
                                          ...photo,
                                          width: img.width,
                                          height: img.height,
                                          aspect,
                                          aspectClass,
                                        });
                                      };
                                      img.onerror = () => {
                                        // Keep original if error
                                        resolve(photo);
                                      };
                                      img.src = photo.url;
                                    });
                                  })
                                );

                                console.log('[PropertiesInspector] Updated photos:', updatedPhotos);

                                onUpdate(selectedItem.id, {
                                  media: {
                                    ...selectedItem.properties.media!,
                                    photos: updatedPhotos,
                                  },
                                });
                              }}
                            >
                              Detect Dimensions
                            </Button>
                            <p className="text-xs text-muted-foreground">
                              Click to detect aspect ratios for photos missing dimension data
                            </p>
                          </div>
                        )}
                        <div className="space-y-2">
                          <Label>Add Photo URL</Label>
                          <div className="flex gap-2">
                            <Input
                              type="url"
                              placeholder="https://cdn.example.com/photo.jpg"
                              onKeyDown={async (e) => {
                                if (e.key === 'Enter') {
                                  const input = e.currentTarget;
                                  const url = input.value.trim();
                                  if (url) {
                                    // Load image to detect dimensions
                                    const img = new Image();
                                    img.crossOrigin = 'anonymous';
                                    img.onload = () => {
                                      const aspect = img.width / img.height;
                                      let aspectClass: 'landscape' | 'portrait' | 'square' = 'square';
                                      if (aspect >= 1.2) aspectClass = 'landscape';
                                      else if (aspect <= 0.85) aspectClass = 'portrait';

                                      const newPhoto = {
                                        url,
                                        order: selectedItem.properties.media?.photos?.length || 0,
                                        width: img.width,
                                        height: img.height,
                                        aspect,
                                        aspectClass,
                                      };
                                      onUpdate(selectedItem.id, {
                                        media: {
                                          ...selectedItem.properties.media!,
                                          photos: [...(selectedItem.properties.media?.photos || []), newPhoto],
                                        },
                                      });
                                      input.value = '';
                                    };
                                    img.onerror = () => {
                                      // Fallback: add without dimensions
                                      const newPhoto = {
                                        url,
                                        order: selectedItem.properties.media?.photos?.length || 0,
                                      };
                                      onUpdate(selectedItem.id, {
                                        media: {
                                          ...selectedItem.properties.media!,
                                          photos: [...(selectedItem.properties.media?.photos || []), newPhoto],
                                        },
                                      });
                                      input.value = '';
                                    };
                                    img.src = url;
                                  }
                                }
                              }}
                            />
                            <Button
                              type="button"
                              size="sm"
                              onClick={(e) => {
                                const input = e.currentTarget.previousElementSibling as HTMLInputElement;
                                const url = input.value.trim();
                                if (url) {
                                  // Load image to detect dimensions
                                  const img = new Image();
                                  img.crossOrigin = 'anonymous';
                                  img.onload = () => {
                                    const aspect = img.width / img.height;
                                    let aspectClass: 'landscape' | 'portrait' | 'square' = 'square';
                                    if (aspect >= 1.2) aspectClass = 'landscape';
                                    else if (aspect <= 0.85) aspectClass = 'portrait';

                                    const newPhoto = {
                                      url,
                                      order: selectedItem.properties.media?.photos?.length || 0,
                                      width: img.width,
                                      height: img.height,
                                      aspect,
                                      aspectClass,
                                    };
                                    onUpdate(selectedItem.id, {
                                      media: {
                                        ...selectedItem.properties.media!,
                                        photos: [...(selectedItem.properties.media?.photos || []), newPhoto],
                                      },
                                    });
                                    input.value = '';
                                  };
                                  img.onerror = () => {
                                    // Fallback: add without dimensions
                                    const newPhoto = {
                                      url,
                                      order: selectedItem.properties.media?.photos?.length || 0,
                                    };
                                    onUpdate(selectedItem.id, {
                                      media: {
                                        ...selectedItem.properties.media!,
                                        photos: [...(selectedItem.properties.media?.photos || []), newPhoto],
                                      },
                                    });
                                    input.value = '';
                                  };
                                  img.src = url;
                                }
                              }}
                            >
                              Add
                            </Button>
                          </div>
                          <p className="text-xs text-muted-foreground">
                            Enter a URL to a photo hosted on a CDN or image hosting service. Press Enter or click Add.
                          </p>
                        </div>
                        {/* Photo list */}
                        {selectedItem.properties.media.photos && selectedItem.properties.media.photos.length > 0 && (
                          <div className="space-y-2">
                            {selectedItem.properties.media.photos
                              .sort((a, b) => a.order - b.order)
                              .map((photo, idx) => (
                                <div key={idx} className="flex items-center gap-2 p-2 border rounded">
                                  <img src={photo.url} alt="" className="w-16 h-16 object-cover rounded" />
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <span className="text-sm">Photo {idx + 1}</span>
                                      {photo.aspectClass && (
                                        <span className={`text-xs px-1.5 py-0.5 rounded font-medium ${
                                          photo.aspectClass === 'landscape' ? 'bg-blue-100 text-blue-700' :
                                          photo.aspectClass === 'portrait' ? 'bg-purple-100 text-purple-700' :
                                          'bg-gray-100 text-gray-700'
                                        }`}>
                                          {photo.aspectClass === 'landscape' ? 'L' : photo.aspectClass === 'portrait' ? 'P' : 'S'}
                                        </span>
                                      )}
                                    </div>
                                    {photo.aspect && (
                                      <p className="text-xs text-muted-foreground">
                                        {photo.width}Ã—{photo.height} ({photo.aspect.toFixed(2)})
                                      </p>
                                    )}
                                  </div>
                                  <Button
                                    variant="ghost"
                                    size="sm"
                                    onClick={() => {
                                      const newPhotos = selectedItem.properties.media!.photos!.filter((_, i) => i !== idx);
                                      onUpdate(selectedItem.id, {
                                        media: {
                                          ...selectedItem.properties.media!,
                                          photos: newPhotos.map((p, i) => ({ ...p, order: i })),
                                        },
                                      });
                                    }}
                                  >
                                    Remove
                                  </Button>
                                </div>
                              ))}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Immersive Slideshow Fields */}
                    {selectedItem.properties.media?.mediaType === 'immersive-slideshow' && (
                      <div className="space-y-4">
                        {/* Slide Duration */}
                        <div className="space-y-2">
                          <Label>Slide Duration (seconds)</Label>
                          <Input
                            type="number"
                            value={selectedItem.properties.media.immersive?.slideDurationSec || 8}
                            onChange={(e) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    slideDurationSec: parseFloat(e.target.value) || 8,
                                  },
                                },
                              });
                            }}
                            min="5"
                            max="15"
                            step="0.5"
                          />
                          <p className="text-xs text-muted-foreground">
                            How long each slide displays (5-15 seconds)
                          </p>
                        </div>

                        {/* Fade Duration */}
                        <div className="space-y-2">
                          <Label>Cross-fade Duration (seconds)</Label>
                          <Input
                            type="number"
                            value={selectedItem.properties.media.immersive?.fadeDurationSec || 0.8}
                            onChange={(e) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    fadeDurationSec: parseFloat(e.target.value) || 0.8,
                                  },
                                },
                              });
                            }}
                            min="0.3"
                            max="2.0"
                            step="0.1"
                          />
                          <p className="text-xs text-muted-foreground">
                            Transition time between slides (0.3-2.0 seconds)
                          </p>
                        </div>

                        {/* Ken Burns Intensity */}
                        <div className="space-y-2">
                          <Label>Ken Burns Intensity</Label>
                          <Select
                            value={selectedItem.properties.media.immersive?.kbIntensity || 'subtle'}
                            onValueChange={(value: 'subtle' | 'medium' | 'strong') => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    kbIntensity: value,
                                  },
                                },
                              });
                            }}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="subtle">Subtle (~6% zoom)</SelectItem>
                              <SelectItem value="medium">Medium (~10% zoom)</SelectItem>
                              <SelectItem value="strong">Strong (~14% zoom)</SelectItem>
                            </SelectContent>
                          </Select>
                          <p className="text-xs text-muted-foreground">
                            Amount of subtle zoom/pan motion
                          </p>
                        </div>

                        {/* Motion Seed */}
                        <div className="space-y-2">
                          <Label>Motion Direction</Label>
                          <Select
                            value={selectedItem.properties.media.immersive?.motionSeed || 'auto'}
                            onValueChange={(value: 'auto' | 'pan-left' | 'pan-right' | 'zoom-in' | 'zoom-out') => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    motionSeed: value,
                                  },
                                },
                              });
                            }}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="auto">Auto (Random)</SelectItem>
                              <SelectItem value="zoom-in">Zoom In</SelectItem>
                              <SelectItem value="zoom-out">Zoom Out</SelectItem>
                              <SelectItem value="pan-left">Pan Left</SelectItem>
                              <SelectItem value="pan-right">Pan Right</SelectItem>
                            </SelectContent>
                          </Select>
                          <p className="text-xs text-muted-foreground">
                            Direction of Ken Burns motion
                          </p>
                        </div>

                        {/* Slide Order */}
                        <div className="space-y-2">
                          <Label>Slide Order</Label>
                          <Select
                            value={selectedItem.properties.media.immersive?.order || 'as-uploaded'}
                            onValueChange={(value: 'as-uploaded' | 'shuffle') => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    order: value,
                                  },
                                },
                              });
                            }}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="as-uploaded">As Uploaded</SelectItem>
                              <SelectItem value="shuffle">Shuffle</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        {/* Show Progress Dots */}
                        <div className="flex items-center justify-between space-x-2">
                          <div className="space-y-0.5">
                            <Label>Progress Indicators</Label>
                            <p className="text-xs text-muted-foreground">
                              Show dots or counter (1/6)
                            </p>
                          </div>
                          <Switch
                            checked={selectedItem.properties.media.immersive?.showProgressDots ?? true}
                            onCheckedChange={(checked) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    showProgressDots: checked,
                                  },
                                },
                              });
                            }}
                          />
                        </div>

                        {/* Reduce Motion on Mobile */}
                        <div className="flex items-center justify-between space-x-2">
                          <div className="space-y-0.5">
                            <Label>Reduce Motion on Mobile</Label>
                            <p className="text-xs text-muted-foreground">
                              Lower intensity for mobile/low-power devices
                            </p>
                          </div>
                          <Switch
                            checked={selectedItem.properties.media.immersive?.reduceMotionOnMobile ?? true}
                            onCheckedChange={(checked) => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    reduceMotionOnMobile: checked,
                                  },
                                },
                              });
                            }}
                          />
                        </div>

                        {/* Focal Point / Crop Control */}
                        <div className="space-y-2">
                          <Label>Default Focal Point</Label>
                          <Select
                            value={selectedItem.properties.media.immersive?.globalFocalPoint || 'center'}
                            onValueChange={(value: 'center' | 'top' | 'bottom' | 'left' | 'right' | 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right') => {
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  immersive: {
                                    ...selectedItem.properties.media!.immersive!,
                                    globalFocalPoint: value,
                                  },
                                },
                              });
                            }}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="center">Center (Default)</SelectItem>
                              <SelectItem value="top">Top</SelectItem>
                              <SelectItem value="bottom">Bottom</SelectItem>
                              <SelectItem value="left">Left</SelectItem>
                              <SelectItem value="right">Right</SelectItem>
                              <SelectItem value="top-left">Top Left</SelectItem>
                              <SelectItem value="top-right">Top Right</SelectItem>
                              <SelectItem value="bottom-left">Bottom Left</SelectItem>
                              <SelectItem value="bottom-right">Bottom Right</SelectItem>
                            </SelectContent>
                          </Select>
                          <p className="text-xs text-muted-foreground">
                            Which part of each image to focus on when cropping (e.g., "Top" for portraits to focus on upper section)
                          </p>
                        </div>

                        {/* Add Photo URL - shared with photos type */}
                        <div className="space-y-2">
                          <Label>Add Photo URL</Label>
                          <div className="flex gap-2">
                            <Input
                              type="url"
                              placeholder="https://cdn.example.com/photo.jpg"
                              onKeyDown={async (e) => {
                                if (e.key === 'Enter') {
                                  const input = e.currentTarget;
                                  const url = input.value.trim();
                                  if (url) {
                                    const newPhoto = {
                                      url,
                                      order: selectedItem.properties.media?.photos?.length || 0,
                                    };
                                    onUpdate(selectedItem.id, {
                                      media: {
                                        ...selectedItem.properties.media!,
                                        photos: [...(selectedItem.properties.media?.photos || []), newPhoto],
                                      },
                                    });
                                    input.value = '';
                                  }
                                }
                              }}
                            />
                            <Button
                              type="button"
                              size="sm"
                              onClick={(e) => {
                                const input = e.currentTarget.previousElementSibling as HTMLInputElement;
                                const url = input.value.trim();
                                if (url) {
                                  const newPhoto = {
                                    url,
                                    order: selectedItem.properties.media?.photos?.length || 0,
                                  };
                                  onUpdate(selectedItem.id, {
                                    media: {
                                      ...selectedItem.properties.media!,
                                      photos: [...(selectedItem.properties.media?.photos || []), newPhoto],
                                    },
                                  });
                                  input.value = '';
                                }
                              }}
                            >
                              Add
                            </Button>
                          </div>
                          <p className="text-xs text-muted-foreground">
                            Press Enter or click Add to include a photo
                          </p>
                        </div>

                        {/* Collection Image Gallery */}
                        {selectedItem.collectionData?.collectionName && selectedItem.collectionData?.vendor && (
                          <CollectionImageGallery
                            collectionName={selectedItem.collectionData.collectionName}
                            vendor={selectedItem.collectionData.vendor}
                            onSelectImages={(urls) => {
                              const currentPhotos = selectedItem.properties.media?.photos || [];
                              const nextOrder = currentPhotos.length;
                              const newPhotos = urls.map((url, idx) => ({
                                url,
                                order: nextOrder + idx,
                              }));
                              onUpdate(selectedItem.id, {
                                media: {
                                  ...selectedItem.properties.media!,
                                  photos: [...currentPhotos, ...newPhotos],
                                },
                              });
                            }}
                          />
                        )}

                        {/* Photo List */}
                        {selectedItem.properties.media?.photos && selectedItem.properties.media.photos.length > 0 && (
                          <div className="space-y-2">
                            <Label>Photos ({selectedItem.properties.media.photos.length})</Label>
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                              {selectedItem.properties.media.photos
                                .sort((a, b) => a.order - b.order)
                                .map((photo, idx) => {
                                  // Convert focalPoint coordinates back to preset name for display
                                  const getFocalPointPreset = () => {
                                    if (!photo.focalPoint) return 'center';
                                    const { x, y } = photo.focalPoint;
                                    if (x === 0.5 && y === 0.5) return 'center';
                                    if (x === 0.5 && y === 0) return 'top';
                                    if (x === 0.5 && y === 1) return 'bottom';
                                    if (x === 0 && y === 0.5) return 'left';
                                    if (x === 1 && y === 0.5) return 'right';
                                    if (x === 0 && y === 0) return 'top-left';
                                    if (x === 1 && y === 0) return 'top-right';
                                    if (x === 0 && y === 1) return 'bottom-left';
                                    if (x === 1 && y === 1) return 'bottom-right';
                                    return 'center';
                                  };

                                  // Convert preset name to focalPoint coordinates
                                  const presetToCoords = (preset: string) => {
                                    const map: Record<string, { x: number; y: number }> = {
                                      'center': { x: 0.5, y: 0.5 },
                                      'top': { x: 0.5, y: 0 },
                                      'bottom': { x: 0.5, y: 1 },
                                      'left': { x: 0, y: 0.5 },
                                      'right': { x: 1, y: 0.5 },
                                      'top-left': { x: 0, y: 0 },
                                      'top-right': { x: 1, y: 0 },
                                      'bottom-left': { x: 0, y: 1 },
                                      'bottom-right': { x: 1, y: 1 },
                                    };
                                    return map[preset] || map.center;
                                  };

                                  return (
                                    <div key={idx} className="p-3 border rounded space-y-2">
                                      <div className="flex items-center gap-2">
                                        <img src={photo.url} alt="" className="w-16 h-16 object-cover rounded" />
                                        <div className="flex-1 min-w-0">
                                          <p className="text-sm font-medium">Photo {idx + 1}</p>
                                          {photo.aspectClass && (
                                            <p className="text-xs text-muted-foreground capitalize">{photo.aspectClass}</p>
                                          )}
                                        </div>
                                        <Button
                                          variant="ghost"
                                          size="sm"
                                          onClick={() => {
                                            const updated = selectedItem.properties.media!.photos!.filter((_, i) => i !== idx);
                                            onUpdate(selectedItem.id, {
                                              media: {
                                                ...selectedItem.properties.media!,
                                                photos: updated.map((p, i) => ({ ...p, order: i })),
                                              },
                                            });
                                          }}
                                        >
                                          Remove
                                        </Button>
                                      </div>

                                      {/* Focal Point for this photo */}
                                      <div className="space-y-1">
                                        <Label className="text-xs">Focal Point</Label>
                                        <Select
                                          value={getFocalPointPreset()}
                                          onValueChange={(value) => {
                                            const coords = presetToCoords(value);
                                            const updatedPhotos = [...selectedItem.properties.media!.photos!];
                                            updatedPhotos[idx] = {
                                              ...updatedPhotos[idx],
                                              focalPoint: coords,
                                            };
                                            onUpdate(selectedItem.id, {
                                              media: {
                                                ...selectedItem.properties.media!,
                                                photos: updatedPhotos,
                                              },
                                            });
                                          }}
                                        >
                                          <SelectTrigger className="h-8 text-xs">
                                            <SelectValue />
                                          </SelectTrigger>
                                          <SelectContent>
                                            <SelectItem value="center">Center (Default)</SelectItem>
                                            <SelectItem value="top">Top</SelectItem>
                                            <SelectItem value="bottom">Bottom</SelectItem>
                                            <SelectItem value="left">Left</SelectItem>
                                            <SelectItem value="right">Right</SelectItem>
                                            <SelectItem value="top-left">Top Left</SelectItem>
                                            <SelectItem value="top-right">Top Right</SelectItem>
                                            <SelectItem value="bottom-left">Bottom Left</SelectItem>
                                            <SelectItem value="bottom-right">Bottom Right</SelectItem>
                                          </SelectContent>
                                        </Select>
                                        <p className="text-xs text-muted-foreground">
                                          Which part to focus on when cropped
                                        </p>
                                      </div>
                                    </div>
                                  );
                                })}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </AccordionContent>
              </AccordionItem>
            )}

            {/* Internal Notes Section */}
            <AccordionItem value="internal-notes">
              <AccordionTrigger className="px-6 text-sm font-medium">
                Internal Notes
              </AccordionTrigger>
              <AccordionContent className="px-6">
                <div className="space-y-2">
                  <Textarea
                    id="notes"
                    placeholder="Add notes for this collection..."
                    value={selectedItem.properties.customNotes ?? ''}
                    onChange={(e) => onUpdate(selectedItem.id, { customNotes: e.target.value })}
                    rows={3}
                    className="text-sm"
                  />
                  <p className="text-xs text-muted-foreground">
                    For internal use only, not visible to customers
                  </p>
                </div>
              </AccordionContent>
            </AccordionItem>

            {/* Reorder Section */}
            {onMoveUp && onMoveDown && presentationItems.length > 0 && (
              <AccordionItem value="reorder">
                <AccordionTrigger className="px-6 text-sm font-medium">
                  Reorder
                </AccordionTrigger>
                <AccordionContent className="px-6">
                  <div className="space-y-2">
                    <div className="flex gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => onMoveUp(selectedItem.id)}
                        disabled={selectedItem.order === 0}
                        className="flex-1"
                      >
                        <ArrowUp className="h-4 w-4 mr-1" />
                        Move Up
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => onMoveDown(selectedItem.id)}
                        disabled={selectedItem.order === presentationItems.length - 1}
                        className="flex-1"
                      >
                        <ArrowDown className="h-4 w-4 mr-1" />
                        Move Down
                      </Button>
                    </div>
                    <p className="text-xs text-muted-foreground">
                      Alternatively, drag the collection card to reorder
                    </p>
                  </div>
                </AccordionContent>
              </AccordionItem>
            )}
          </Accordion>
        )}

        {/* Bulk Mode UI */}
        {selectedItem?.type === 'collection' && isBulkMode && (
          <div className="p-6 space-y-4">
            <p className="text-xs text-muted-foreground mb-4">
              Changes will apply to all {selectionCount} selected collections
            </p>

            {/* Start Expanded Toggle */}
            <div className="flex items-center justify-between">
              <div className="space-y-0.5">
                <Label htmlFor="bulk-start-expanded" className="text-sm font-medium">
                  Start Expanded
                </Label>
                <p className="text-xs text-muted-foreground">
                  Show products immediately
                </p>
              </div>
              <Switch
                id="bulk-start-expanded"
                checked={selectedItem?.properties.startExpanded ?? false}
                onCheckedChange={(checked) => {
                  if (onBulkUpdate) {
                    onBulkUpdate({ startExpanded: checked });
                  }
                }}
              />
            </div>

            {/* Show Product Count Toggle */}
            <div className="flex items-center justify-between">
              <div className="space-y-0.5">
                <Label htmlFor="bulk-show-count" className="text-sm font-medium">
                  Show Product Count
                </Label>
                <p className="text-xs text-muted-foreground">
                  Display number of items
                </p>
              </div>
              <Switch
                id="bulk-show-count"
                checked={selectedItem?.properties.showProductCount ?? true}
                onCheckedChange={(checked) => {
                  if (onBulkUpdate) {
                    onBulkUpdate({ showProductCount: checked });
                  }
                }}
              />
            </div>
          </div>
        )}

        {/* Section Header properties */}
        {selectedItem?.type === 'section_header' && (
          <div className="p-6 text-xs text-muted-foreground">
            Section header properties can be edited inline in the canvas.
          </div>
        )}
      </CardContent>
    </Card>
  );
}
